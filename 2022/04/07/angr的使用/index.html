<!DOCTYPE html><html lang="zh"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>angr | shimmer's blog</title><script>var config = {"root":"/","search":{"preload":false,"activeHolder":"键入以继续","blurHolder":"数据检索","noResult":"无 $0 相关数据"},"code":{"codeInfo":"$0 共 $1 行","copy":"复制","copyFinish":"完成","expand":"展开"}}</script><script src="//unpkg.com/valine/dist/Valine.min.js"></script><script src="//unpkg.com/mermaid@9.2.2/dist/mermaid.min.js"></script><script>mermaid.initialize({
 startOnLoad: true
 , theme: 'dark'
});</script><link rel="stylesheet" href="/css/arknights.css"><link rel="stylesheet" href="//unpkg.com/@highlightjs/cdn-assets@11.6.0/styles/atom-one-dark-reasonable.min.css"><style>@font-face {
 font-family: BenderLight;
 src: local('Bender'), url("/font/BenderLight.ttf");
}
@font-face {
 font-family: 'JetBrains Mono';
 src: local('JetBrains Mono'), url('/font/JetBrainsMono-Regular.woff2') format('woff2');
}</style><meta name="generator" content="Hexo 6.3.0"></head><body style="background-image:url(https://ak.hypergryph.com/assets/index/images/ak/pc/bk.jpg);"><main><header class="closed"><nav><div class="navBtn hide"><i class="navBtnIcon"><span class="navBtnIconBar"></span><span class="navBtnIconBar"></span><span class="navBtnIconBar"></span></i></div><ol class="navContent"><li class="navItem" id="search-header"><span class="navItemTitle"><input autocomplete="off" autocorrect="off" autocapitalize="none" placeholder="数据检索" spellcheck="false" maxlength="50" type="text" id="search-input"></span></li><li class="navItem"><a class="navBlock" href="/"><span class="navItemTitle">Home</span></a></li><li class="navItem" matchdata="categories,tags"><a class="navBlock" href="/archives/"><span class="navItemTitle">Archives</span></a></li></ol></nav><div class="search-popup"><div id="search-result"></div></div></header><article><div id="post-bg"><div id="post-title"><h1>angr</h1><div id="post-info"><span>First Post: <div class="control"><time datetime="2022-04-07T11:00:00.000Z" id="date"> 2022-04-07</time></div></span><br><span>Last Update: <div class="control"><time datetime="2023-04-08T01:23:42.634Z" id="updated"> 2023-04-08</time></div></span></div></div><hr><div id="post-content"><p>主要是记录一下这些脚本，真正理解暂时有点困难</p>
<p>附上大佬的教程：<a target="_blank" rel="noopener" href="https://github.com/ZERO-A-ONE/AngrCTF_FITM">https://github.com/ZERO-A-ONE/AngrCTF_FITM</a></p>
<h2 id="一-good："><a href="#一-good：" class="headerlink" title="一.good："></a>一.good：</h2><p>程序源码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> __cdecl <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">const</span> <span class="hljs-type">char</span> **argv, <span class="hljs-type">const</span> <span class="hljs-type">char</span> **envp)</span><br>&#123;<br>  <span class="hljs-type">signed</span> <span class="hljs-type">int</span> i; <span class="hljs-comment">// [esp+1Ch] [ebp-1Ch]</span><br>  <span class="hljs-type">char</span> s1[<span class="hljs-number">9</span>]; <span class="hljs-comment">// [esp+23h] [ebp-15h]</span><br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> v6; <span class="hljs-comment">// [esp+2Ch] [ebp-Ch]</span><br><br>  v6 = __readgsdword(<span class="hljs-number">0x14</span>u);<br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Enter the password: &quot;</span>);<br>  __isoc99_scanf(<span class="hljs-string">&quot;%8s&quot;</span>, s1);<br>  <span class="hljs-keyword">for</span> ( i = <span class="hljs-number">0</span>; i &lt;= <span class="hljs-number">7</span>; ++i )<br>    s1[i] = complex_function(s1[i], i);<br>  <span class="hljs-keyword">if</span> ( !<span class="hljs-built_in">strcmp</span>(s1, <span class="hljs-string">&quot;JACEJGCS&quot;</span>) )<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Good Job.&quot;</span>);<br>  <span class="hljs-keyword">else</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Try again.&quot;</span>);<br>  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>使用Angr的步骤可以分为：</p>
<ul>
<li>创建 project</li>
<li>设置 state</li>
<li>新建符号量 : BVS (bitvector symbolic ) 或 BVV (bitvector value)</li>
<li>把符号量设置到内存或者其他地方</li>
<li>设置 Simulation Managers ， 进行路径探索的对象</li>
<li>运行，探索满足路径需要的值</li>
<li>约束求解，获取执行结果</li>
</ul>
<p>angr脚本：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> angr<br><span class="hljs-keyword">import</span> sys<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">Go</span>():<br>    path_to_binary = <span class="hljs-string">&quot;./00_angr_find&quot;</span> <br>    project = angr.Project(path_to_binary, auto_load_libs=<span class="hljs-literal">False</span>)<br>    initial_state = project.factory.entry_state()<br>    simulation = project.factory.simgr(initial_state)<br><br>    print_good_address = <span class="hljs-number">0x8048678</span>  <br>    simulation.explore(find=print_good_address)<br>  <br>    <span class="hljs-keyword">if</span> simulation.found:<br>        solution_state = simulation.found[<span class="hljs-number">0</span>]<br>        solution = solution_state.posix.dumps(sys.stdin.fileno())<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;[+] Success! Solution is: &#123;&#125;&quot;</span>.<span class="hljs-built_in">format</span>(solution.decode(<span class="hljs-string">&quot;utf-8&quot;</span>)))<br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-keyword">raise</span> Exception(<span class="hljs-string">&#x27;Could not find the solution&#x27;</span>)<br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&quot;__main__&quot;</span>:<br>    Go()<br></code></pre></td></tr></table></figure>

<h2 id="二-good-avoid"><a href="#二-good-avoid" class="headerlink" title="二.good_avoid"></a>二.good_avoid</h2><p>angr脚本：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> angr<br><span class="hljs-keyword">import</span> sys<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">Go</span>():<br>    path_to_binary = <span class="hljs-string">&quot;./01_angr_avoid&quot;</span> <br>    project = angr.Project(path_to_binary, auto_load_libs=<span class="hljs-literal">False</span>)<br>    initial_state = project.factory.entry_state()<br>    simulation = project.factory.simgr(initial_state)<br><br>    avoid_me_address =   <span class="hljs-number">0x080485A8</span><br>    maybe_good_address = <span class="hljs-number">0x080485E0</span><br><br>    simulation.explore(find=maybe_good_address, avoid=avoid_me_address)<br>  <br>    <span class="hljs-keyword">if</span> simulation.found:<br>        solution_state = simulation.found[<span class="hljs-number">0</span>]<br>        solution = solution_state.posix.dumps(sys.stdin.fileno())<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;[+] Success! Solution is: &#123;&#125;&quot;</span>.<span class="hljs-built_in">format</span>(solution.decode(<span class="hljs-string">&quot;utf-8&quot;</span>)))<br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-keyword">raise</span> Exception(<span class="hljs-string">&#x27;Could not find the solution&#x27;</span>)<br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&quot;__main__&quot;</span>:<br>    Go()<br></code></pre></td></tr></table></figure>

<p>这个我试着跑了一下，挺成功的</p>
<p><img src="https://raw.githubusercontent.com/shimmer123456/img/main/img/202304072232390.png"></p>
<h2 id="三-多个good或avoid"><a href="#三-多个good或avoid" class="headerlink" title="三.多个good或avoid"></a>三.多个good或avoid</h2><p>程序源码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> __cdecl <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">const</span> <span class="hljs-type">char</span> **argv, <span class="hljs-type">const</span> <span class="hljs-type">char</span> **envp)</span><br>&#123;<br>  <span class="hljs-type">signed</span> <span class="hljs-type">int</span> i; <span class="hljs-comment">// [esp+18h] [ebp-40h]</span><br>  <span class="hljs-type">signed</span> <span class="hljs-type">int</span> j; <span class="hljs-comment">// [esp+1Ch] [ebp-3Ch]</span><br>  <span class="hljs-type">char</span> s1[<span class="hljs-number">20</span>]; <span class="hljs-comment">// [esp+24h] [ebp-34h]</span><br>  <span class="hljs-type">char</span> s2[<span class="hljs-number">4</span>]; <span class="hljs-comment">// [esp+38h] [ebp-20h]</span><br>  <span class="hljs-type">int</span> v8; <span class="hljs-comment">// [esp+3Ch] [ebp-1Ch]</span><br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> v9; <span class="hljs-comment">// [esp+4Ch] [ebp-Ch]</span><br><br>  v9 = __readgsdword(<span class="hljs-number">0x14</span>u);<br>  <span class="hljs-keyword">for</span> ( i = <span class="hljs-number">0</span>; i &lt;= <span class="hljs-number">19</span>; ++i )<br>    s2[i] = <span class="hljs-number">0</span>;<br>  *(_DWORD *)s2 = <span class="hljs-number">1381128278</span>;<br>  v8 = <span class="hljs-number">1381320010</span>;<br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Enter the password: &quot;</span>);<br>  __isoc99_scanf(<span class="hljs-string">&quot;%8s&quot;</span>, s1);<br>  <span class="hljs-keyword">for</span> ( j = <span class="hljs-number">0</span>; j &lt;= <span class="hljs-number">7</span>; ++j )<br>    s1[j] = complex_function(s1[j], j + <span class="hljs-number">8</span>);<br>  <span class="hljs-keyword">if</span> ( !<span class="hljs-built_in">strcmp</span>(s1, s2) )<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Good Job.&quot;</span>);<br>  <span class="hljs-keyword">else</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Try again.&quot;</span>);<br>  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> __cdecl <span class="hljs-title function_">complex_function</span><span class="hljs-params">(<span class="hljs-type">signed</span> <span class="hljs-type">int</span> a1, <span class="hljs-type">int</span> a2)</span><br>&#123;<br>  <span class="hljs-keyword">if</span> ( a1 &lt;= <span class="hljs-number">64</span> || a1 &gt; <span class="hljs-number">90</span> )<br>  &#123;<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Try again.&quot;</span>);<br>    <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<br>  &#125;<br>  <span class="hljs-keyword">return</span> (<span class="hljs-number">31</span> * a2 + a1 - <span class="hljs-number">65</span>) % <span class="hljs-number">26</span> + <span class="hljs-number">65</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>angr的exp</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> angr<br><span class="hljs-keyword">import</span> sys<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">Go</span>():<br>    path_to_binary = <span class="hljs-string">&quot;./02_angr_find_condition&quot;</span> <br>    project = angr.Project(path_to_binary, auto_load_libs=<span class="hljs-literal">False</span>)<br>    initial_state = project.factory.entry_state()<br>    simulation = project.factory.simgr(initial_state)<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">is_successful</span>(<span class="hljs-params">state</span>):<br>        stdout_output = state.posix.dumps(sys.stdout.fileno())<br>        <span class="hljs-keyword">if</span> <span class="hljs-string">b&#x27;Good Job.&#x27;</span> <span class="hljs-keyword">in</span> stdout_output:<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span><br>        <span class="hljs-keyword">else</span>: <br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">should_abort</span>(<span class="hljs-params">state</span>):<br>        stdout_output = state.posix.dumps(sys.stdout.fileno())<br>        <span class="hljs-keyword">if</span> <span class="hljs-string">b&#x27;Try again.&#x27;</span> <span class="hljs-keyword">in</span>  stdout_output:<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span><br>        <span class="hljs-keyword">else</span>: <br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br><br>    simulation.explore(find=is_successful, avoid=should_abort)<br>  <br>    <span class="hljs-keyword">if</span> simulation.found:<br>        solution_state = simulation.found[<span class="hljs-number">0</span>]<br>        solution = solution_state.posix.dumps(sys.stdin.fileno())<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;[+] Success! Solution is: &#123;&#125;&quot;</span>.<span class="hljs-built_in">format</span>(solution.decode(<span class="hljs-string">&quot;utf-8&quot;</span>)))<br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-keyword">raise</span> Exception(<span class="hljs-string">&#x27;Could not find the solution&#x27;</span>)<br>    <br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&quot;__main__&quot;</span>:<br>    Go()<br></code></pre></td></tr></table></figure>

<p>引用了两个函数可以动态的获取地址，而不是之前“写死”</p>
<h2 id="四-符号化寄存器"><a href="#四-符号化寄存器" class="headerlink" title="四.符号化寄存器"></a>四.符号化寄存器</h2><p>程序源码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> __cdecl <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">const</span> <span class="hljs-type">char</span> **argv, <span class="hljs-type">const</span> <span class="hljs-type">char</span> **envp)</span><br>&#123;<br>  <span class="hljs-type">int</span> v3; <span class="hljs-comment">// ebx</span><br>  <span class="hljs-type">int</span> v4; <span class="hljs-comment">// eax</span><br>  <span class="hljs-type">int</span> v5; <span class="hljs-comment">// edx</span><br>  <span class="hljs-type">int</span> v6; <span class="hljs-comment">// ST1C_4</span><br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> v7; <span class="hljs-comment">// ST14_4</span><br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> v9; <span class="hljs-comment">// [esp+8h] [ebp-10h]</span><br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> v10; <span class="hljs-comment">// [esp+Ch] [ebp-Ch]</span><br><br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Enter the password: &quot;</span>);<br>  v4 = get_user_input();<br>  v6 = v5;<br>  v7 = complex_function_1(v4);<br>  v9 = complex_function_2(v3);<br>  v10 = complex_function_3(v6);<br>  <span class="hljs-keyword">if</span> ( v7 || v9 || v10 )<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Try again.&quot;</span>);<br>  <span class="hljs-keyword">else</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Good Job.&quot;</span>);<br>  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">get_user_input</span><span class="hljs-params">()</span><br>&#123;<br>  <span class="hljs-type">int</span> v1; <span class="hljs-comment">// [esp+0h] [ebp-18h]</span><br>  <span class="hljs-type">int</span> v2; <span class="hljs-comment">// [esp+4h] [ebp-14h]</span><br>  <span class="hljs-type">int</span> v3; <span class="hljs-comment">// [esp+8h] [ebp-10h]</span><br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> v4; <span class="hljs-comment">// [esp+Ch] [ebp-Ch]</span><br><br>  v4 = __readgsdword(<span class="hljs-number">0x14</span>u);<br>  __isoc99_scanf(<span class="hljs-string">&quot;%x %x %x&quot;</span>, &amp;v1, &amp;v2, &amp;v3);<br>  <span class="hljs-keyword">return</span> v1;<br>&#125;<br></code></pre></td></tr></table></figure>



<p>angr的exp：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> angr<br><span class="hljs-keyword">import</span> sys<br><span class="hljs-keyword">import</span> claripy<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">Go</span>():<br>    path_to_binary = <span class="hljs-string">&quot;./03_angr_symbolic_registers&quot;</span> <br>    project = angr.Project(path_to_binary, auto_load_libs=<span class="hljs-literal">False</span>)<br>    start_address = <span class="hljs-number">0x08048980</span>  <span class="hljs-comment">#跳过get_user_input(),直接修改三个寄存器数据</span><br>    initial_state = project.factory.blank_state(addr=start_address)<br><br>    passwd_size_in_bits = <span class="hljs-number">32</span><br>    passwd0 = claripy.BVS(<span class="hljs-string">&#x27;passwd0&#x27;</span>, passwd_size_in_bits)<br>    passwd1 = claripy.BVS(<span class="hljs-string">&#x27;passwd1&#x27;</span>, passwd_size_in_bits)<br>    passwd2 = claripy.BVS(<span class="hljs-string">&#x27;passwd2&#x27;</span>, passwd_size_in_bits)<br><br>    initial_state.regs.eax = passwd0<br>    initial_state.regs.ebx = passwd1<br>    initial_state.regs.edx = passwd2<br>    <br>    simulation = project.factory.simgr(initial_state) <br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">is_successful</span>(<span class="hljs-params">state</span>):<br>        stdout_output = state.posix.dumps(sys.stdout.fileno())<br>        <span class="hljs-keyword">if</span> <span class="hljs-string">b&#x27;Good Job.\n&#x27;</span> <span class="hljs-keyword">in</span> stdout_output:<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span><br>        <span class="hljs-keyword">else</span>: <br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">should_abort</span>(<span class="hljs-params">state</span>):<br>        stdout_output = state.posix.dumps(sys.stdout.fileno())<br>        <span class="hljs-keyword">if</span> <span class="hljs-string">b&#x27;Try again.\n&#x27;</span> <span class="hljs-keyword">in</span>  stdout_output:<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span><br>        <span class="hljs-keyword">else</span>: <br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br><br>    simulation.explore(find=is_successful, avoid=should_abort)<br>  <br>    <span class="hljs-keyword">if</span> simulation.found:<br>        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> simulation.found:<br>            solution_state = i<br>            solution0 = <span class="hljs-built_in">format</span>(solution_state.solver.<span class="hljs-built_in">eval</span>(passwd0), <span class="hljs-string">&#x27;x&#x27;</span>)<br>            solution1 = <span class="hljs-built_in">format</span>(solution_state.solver.<span class="hljs-built_in">eval</span>(passwd1), <span class="hljs-string">&#x27;x&#x27;</span>)<br>            solution2 = <span class="hljs-built_in">format</span>(solution_state.solver.<span class="hljs-built_in">eval</span>(passwd2), <span class="hljs-string">&#x27;x&#x27;</span>)<br>            solution = solution0 + <span class="hljs-string">&quot; &quot;</span> + solution1 + <span class="hljs-string">&quot; &quot;</span> + solution2<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;[+] Success! Solution is: &#123;&#125;&quot;</span>.<span class="hljs-built_in">format</span>(solution))<br>            <span class="hljs-comment"># print(simgr.found[0].posix.dumps(0))</span><br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-keyword">raise</span> Exception(<span class="hljs-string">&#x27;Could not find the solution&#x27;</span>)<br>    <br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&quot;__main__&quot;</span>:<br>    Go()<br></code></pre></td></tr></table></figure>

<h2 id="五-符号化栈"><a href="#五-符号化栈" class="headerlink" title="五.符号化栈"></a>五.符号化栈</h2><p>应用情况就是函数在输入传参的时候是在栈上进行的</p>
<p>如图：<img src="https://camo.githubusercontent.com/d75d977287d32f2af020166fa49a0ff886b1d98900e56129b9c91ce780bf5833/68747470733a2f2f6e6f74652d626f6f6b2e6f62732e636e2d656173742d332e6d79687561776569636c6f75642e636f6d2f416e67725f4354462f2545342542412538432f2545352542452541452545342542462541312545352539422542452545372538392538375f32303230303830353130303635372e706e67" alt="img"></p>
<p>程序源码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> __cdecl <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">const</span> <span class="hljs-type">char</span> **argv, <span class="hljs-type">const</span> <span class="hljs-type">char</span> **envp)</span><br>&#123;<br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Enter the password: &quot;</span>);<br>  handle_user();<br>  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">handle_user</span><span class="hljs-params">()</span><br>&#123;<br>  <span class="hljs-type">int</span> result; <span class="hljs-comment">// eax</span><br>  <span class="hljs-type">int</span> v1; <span class="hljs-comment">// [esp+8h] [ebp-10h]</span><br>  <span class="hljs-type">int</span> v2; <span class="hljs-comment">// [esp+Ch] [ebp-Ch]</span><br><br>  __isoc99_scanf(<span class="hljs-string">&quot;%u %u&quot;</span>, &amp;v2, &amp;v1);<br>  v2 = complex_function0(v2);<br>  v1 = complex_function1(v1);<br>  <span class="hljs-keyword">if</span> ( v2 == <span class="hljs-number">1999643857</span> &amp;&amp; v1 == <span class="hljs-number">-1136455217</span> )<br>    result = <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Good Job.&quot;</span>);<br>  <span class="hljs-keyword">else</span><br>    result = <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Try again.&quot;</span>);<br>  <span class="hljs-keyword">return</span> result;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>angr的exp：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> angr<br><span class="hljs-keyword">import</span> sys<br><span class="hljs-keyword">import</span> claripy<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">Go</span>():<br>    path_to_binary = <span class="hljs-string">&quot;./04_angr_symbolic_stack&quot;</span> <br>    project = angr.Project(path_to_binary, auto_load_libs=<span class="hljs-literal">False</span>)<br>    start_address = <span class="hljs-number">0x8048697</span><span class="hljs-comment">#还是跳过输入，直接从栈上符号化输入的参数</span><br>    initial_state = project.factory.blank_state(addr=start_address)<br><br>    initial_state.regs.ebp = initial_state.regs.esp<span class="hljs-comment">#初始化，是esp和ebp相同</span><br> <br>    passwd_size_in_bits = <span class="hljs-number">32</span><br>    passwd0 = claripy.BVS(<span class="hljs-string">&#x27;passwd0&#x27;</span>, passwd_size_in_bits)<br>    passwd1 = claripy.BVS(<span class="hljs-string">&#x27;passwd1&#x27;</span>, passwd_size_in_bits)<br><br>    padding_length_in_bytes = <span class="hljs-number">0x8</span><span class="hljs-comment">#先抬高栈，以便在将符号值压入堆栈之前提供填充，但是栈是从高地址到低地址增长的，所以我们真正需要的是ESP - 0x8</span><br>    initial_state.regs.esp -= padding_length_in_bytes<br>    <br>    initial_state.stack_push(passwd0)  <br>    initial_state.stack_push(passwd1) <br><br>    simulation = project.factory.simgr(initial_state)<br>    <br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">is_successful</span>(<span class="hljs-params">state</span>):<br>        stdout_output = state.posix.dumps(<span class="hljs-number">1</span>)<br>        <span class="hljs-keyword">if</span> <span class="hljs-string">b&#x27;Good Job.\n&#x27;</span> <span class="hljs-keyword">in</span> stdout_output:<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span><br>        <span class="hljs-keyword">else</span>: <br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">should_abort</span>(<span class="hljs-params">state</span>):<br>        stdout_output = state.posix.dumps(<span class="hljs-number">1</span>)<br>        <span class="hljs-keyword">if</span> <span class="hljs-string">b&#x27;Try again.\n&#x27;</span> <span class="hljs-keyword">in</span>  stdout_output:<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span><br>        <span class="hljs-keyword">else</span>: <br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br><br>    simulation.explore(find=is_successful, avoid=should_abort)<br>  <br>    <span class="hljs-keyword">if</span> simulation.found:<br>        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> simulation.found:<br>            solution_state = i<br>            solution0 = (solution_state.solver.<span class="hljs-built_in">eval</span>(passwd0))<br>            solution1 = (solution_state.solver.<span class="hljs-built_in">eval</span>(passwd1))<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;[+] Success! Solution is: &#123;0&#125; &#123;1&#125;&quot;</span>.<span class="hljs-built_in">format</span>(solution0, solution1))<br>            <span class="hljs-comment">#print(solution0, solution1)</span><br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-keyword">raise</span> Exception(<span class="hljs-string">&#x27;Could not find the solution&#x27;</span>)<br>    <br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&quot;__main__&quot;</span>:<br>    Go()<br></code></pre></td></tr></table></figure>

<h2 id="六-符号化内存"><a href="#六-符号化内存" class="headerlink" title="六.符号化内存"></a>六.符号化内存</h2><p>程序源码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> __cdecl <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">const</span> <span class="hljs-type">char</span> **argv, <span class="hljs-type">const</span> <span class="hljs-type">char</span> **envp)</span><br>&#123;<br>  <span class="hljs-type">int</span> i; <span class="hljs-comment">// [esp+Ch] [ebp-Ch]</span><br><br>  <span class="hljs-built_in">memset</span>(user_input, <span class="hljs-number">0</span>, <span class="hljs-number">0x21</span>u);<br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Enter the password: &quot;</span>);<br>  __isoc99_scanf(<span class="hljs-string">&quot;%8s %8s %8s %8s&quot;</span>, user_input, &amp;unk_A1BA1C8, &amp;unk_A1BA1D0, &amp;unk_A1BA1D8);<br>  <span class="hljs-keyword">for</span> ( i = <span class="hljs-number">0</span>; i &lt;= <span class="hljs-number">31</span>; ++i )<br>    *(_BYTE *)(i + <span class="hljs-number">0xA1BA1C0</span>) = complex_function(*(<span class="hljs-type">char</span> *)(i + <span class="hljs-number">0xA1BA1C0</span>), i);<span class="hljs-comment">// user_input = 0xA1BA1C0</span><br>  <span class="hljs-keyword">if</span> ( !<span class="hljs-built_in">strncmp</span>(user_input, <span class="hljs-string">&quot;NJPURZPCDYEAXCSJZJMPSOMBFDDLHBVN&quot;</span>, <span class="hljs-number">0x20</span>u) )<span class="hljs-comment">// 用来比较s1和s2字符串的前n个字符</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Good Job.&quot;</span>);<br>  <span class="hljs-keyword">else</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Try again.&quot;</span>);<br>  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>user_input()所处的地址：</p>
<p><img src="https://camo.githubusercontent.com/c7169745566e2064051181950bcd9e1434d7c80061616e7a365f837cd9c41086/68747470733a2f2f6e6f74652d626f6f6b2e6f62732e636e2d656173742d332e6d79687561776569636c6f75642e636f6d2f416e67725f4354462f2545342542412538432f2545352542452541452545342542462541312545352539422542452545372538392538375f32303230303830363231303932372e706e67" alt="img"></p>
<p>字符串分别位于以下地址[0xA1BA1C0, 0xA1BA1C8, 0xA1BA1D0, 0xA1BA1D8]</p>
<p>angr的exp：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> angr<br><span class="hljs-keyword">import</span> sys<br><span class="hljs-keyword">import</span> claripy<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">Go</span>():<br>    path_to_binary = <span class="hljs-string">&quot;./05_angr_symbolic_memory&quot;</span> <br>    project = angr.Project(path_to_binary, auto_load_libs=<span class="hljs-literal">False</span>)<br>    start_address = <span class="hljs-number">0x8048601</span><span class="hljs-comment">#跳过输入，直接去内存里符号化四个字符串</span><br>    initial_state = project.factory.blank_state(addr=start_address)<br> <br>    passwd_size_in_bits = <span class="hljs-number">64</span><br>    passwd0 = claripy.BVS(<span class="hljs-string">&#x27;passwd0&#x27;</span>, passwd_size_in_bits)<br>    passwd1 = claripy.BVS(<span class="hljs-string">&#x27;passwd1&#x27;</span>, passwd_size_in_bits)<br>    passwd2 = claripy.BVS(<span class="hljs-string">&#x27;passwd2&#x27;</span>, passwd_size_in_bits)<br>    passwd3 = claripy.BVS(<span class="hljs-string">&#x27;passwd3&#x27;</span>, passwd_size_in_bits)<br><br>    passwd0_address = <span class="hljs-number">0xA1BA1C0</span><br>    <span class="hljs-comment">#passwd1_address = 0xA1BA1C8</span><br>    <span class="hljs-comment">#passwd2_address = 0xA1BA1D0</span><br>    <span class="hljs-comment">#passwd3_address = 0xA1BA1D8</span><br>    initial_state.memory.store(passwd0_address, passwd0)<br>    initial_state.memory.store(passwd0_address + <span class="hljs-number">0x8</span>,  passwd1)<br>    initial_state.memory.store(passwd0_address + <span class="hljs-number">0x10</span>, passwd2)<br>    initial_state.memory.store(passwd0_address + <span class="hljs-number">0x18</span>, passwd3)<br><br>    simulation = project.factory.simgr(initial_state)<br>    <br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">is_successful</span>(<span class="hljs-params">state</span>):<br>        stdout_output = state.posix.dumps(<span class="hljs-number">1</span>)<br>        <span class="hljs-keyword">if</span> <span class="hljs-string">b&#x27;Good Job.\n&#x27;</span> <span class="hljs-keyword">in</span> stdout_output:<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span><br>        <span class="hljs-keyword">else</span>: <br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">should_abort</span>(<span class="hljs-params">state</span>):<br>        stdout_output = state.posix.dumps(<span class="hljs-number">1</span>)<br>        <span class="hljs-keyword">if</span> <span class="hljs-string">b&#x27;Try again.\n&#x27;</span> <span class="hljs-keyword">in</span>  stdout_output:<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span><br>        <span class="hljs-keyword">else</span>: <br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br><br>    simulation.explore(find=is_successful, avoid=should_abort)<br>  <br>    <span class="hljs-keyword">if</span> simulation.found:<br>        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> simulation.found:<br>            solution_state = i<br>            solution0 = solution_state.solver.<span class="hljs-built_in">eval</span>(passwd0,cast_to=<span class="hljs-built_in">bytes</span>)<br>            solution1 = solution_state.solver.<span class="hljs-built_in">eval</span>(passwd1,cast_to=<span class="hljs-built_in">bytes</span>)<br>            solution2 = solution_state.solver.<span class="hljs-built_in">eval</span>(passwd2,cast_to=<span class="hljs-built_in">bytes</span>)<br>            solution3 = solution_state.solver.<span class="hljs-built_in">eval</span>(passwd3,cast_to=<span class="hljs-built_in">bytes</span>)<br>            solution = solution0 + <span class="hljs-string">b&quot; &quot;</span> + solution1 + <span class="hljs-string">b&quot; &quot;</span> + solution2 + <span class="hljs-string">b&quot; &quot;</span> + solution3<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;[+] Success! Solution is: &#123;&#125;&quot;</span>.<span class="hljs-built_in">format</span>(solution.decode(<span class="hljs-string">&quot;utf-8&quot;</span>)))<br>            <span class="hljs-comment">#print(solution0, solution1, solution2, solution3)</span><br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-keyword">raise</span> Exception(<span class="hljs-string">&#x27;Could not find the solution&#x27;</span>)<br>    <br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&quot;__main__&quot;</span>:<br>    Go()<br></code></pre></td></tr></table></figure>

<h2 id="七-符号化动态内存"><a href="#七-符号化动态内存" class="headerlink" title="七.符号化动态内存"></a>七.符号化动态内存</h2><p>程序源码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> __cdecl <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">const</span> <span class="hljs-type">char</span> **argv, <span class="hljs-type">const</span> <span class="hljs-type">char</span> **envp)</span><br>&#123;<br>  <span class="hljs-type">char</span> *v3; <span class="hljs-comment">// ebx</span><br>  <span class="hljs-type">char</span> *v4; <span class="hljs-comment">// ebx</span><br>  <span class="hljs-type">int</span> v6; <span class="hljs-comment">// [esp-10h] [ebp-1Ch]</span><br>  <span class="hljs-type">signed</span> <span class="hljs-type">int</span> i; <span class="hljs-comment">// [esp+0h] [ebp-Ch]</span><br><br>  buffer0 = (<span class="hljs-type">char</span> *)<span class="hljs-built_in">malloc</span>(<span class="hljs-number">9u</span>);<br>  buffer1 = (<span class="hljs-type">char</span> *)<span class="hljs-built_in">malloc</span>(<span class="hljs-number">9u</span>);<br>  <span class="hljs-built_in">memset</span>(buffer0, <span class="hljs-number">0</span>, <span class="hljs-number">9u</span>);<br>  <span class="hljs-built_in">memset</span>(buffer1, <span class="hljs-number">0</span>, <span class="hljs-number">9u</span>);<br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Enter the password: &quot;</span>);<br>  __isoc99_scanf(<span class="hljs-string">&quot;%8s %8s&quot;</span>, buffer0, buffer1, v6);<br>  <span class="hljs-keyword">for</span> ( i = <span class="hljs-number">0</span>; i &lt;= <span class="hljs-number">7</span>; ++i )<br>  &#123;<br>    v3 = &amp;buffer0[i];<br>    *v3 = complex_function(buffer0[i], i);<br>    v4 = &amp;buffer1[i];<br>    *v4 = complex_function(buffer1[i], i + <span class="hljs-number">32</span>);<br>  &#125;<br>  <span class="hljs-keyword">if</span> ( !<span class="hljs-built_in">strncmp</span>(buffer0, <span class="hljs-string">&quot;UODXLZBI&quot;</span>, <span class="hljs-number">8u</span>) &amp;&amp; !<span class="hljs-built_in">strncmp</span>(buffer1, <span class="hljs-string">&quot;UAORRAYF&quot;</span>, <span class="hljs-number">8u</span>) )<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Good Job.&quot;</span>);<br>  <span class="hljs-keyword">else</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Try again.&quot;</span>);<br>  <span class="hljs-built_in">free</span>(buffer0);<br>  <span class="hljs-built_in">free</span>(buffer1);<br>  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>angr的exp：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> angr<br><span class="hljs-keyword">import</span> sys<br><span class="hljs-keyword">import</span> claripy<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">Go</span>():<br>    path_to_binary = <span class="hljs-string">&quot;./06_angr_symbolic_dynamic_memory&quot;</span> <br>    project = angr.Project(path_to_binary, auto_load_libs=<span class="hljs-literal">False</span>)<br>    start_address = <span class="hljs-number">0x8048699</span> <span class="hljs-comment">#跳过malloc和scanf</span><br>    initial_state = project.factory.blank_state(addr=start_address)<br><br>    passwd_size_in_bits = <span class="hljs-number">64</span><br>    passwd0 = claripy.BVS(<span class="hljs-string">&#x27;passwd0&#x27;</span>, passwd_size_in_bits)<br>    passwd1 = claripy.BVS(<span class="hljs-string">&#x27;passwd1&#x27;</span>, passwd_size_in_bits)<br><br>    fake_heap_address0 = <span class="hljs-number">0xffffc93c</span><span class="hljs-comment">#假地址</span><br>    pointer_to_malloc_memory_address0 = <span class="hljs-number">0xabcc8a4</span><span class="hljs-comment">#malloc的buffer0地址</span><br>    fake_heap_address1 = <span class="hljs-number">0xffffc94c</span><span class="hljs-comment">#假地址</span><br>    pointer_to_malloc_memory_address1 = <span class="hljs-number">0xabcc8ac</span><span class="hljs-comment">#malloc的buffer1地址</span><br>    initial_state.memory.store(pointer_to_malloc_memory_address0, fake_heap_address0, endness=project.arch.memory_endness)<br>    initial_state.memory.store(pointer_to_malloc_memory_address1, fake_heap_address1, endness=project.arch.memory_endness)<br>    <br>    <span class="hljs-comment">#这里总的逻辑是这样的，之前是buffer指向的是malloc分配好的内存地址，string存在这里。现在是buffer指向的是我们伪造的地址，符号位向量存在这里</span><br><br>    initial_state.memory.store(fake_heap_address0, passwd0)  <br>    initial_state.memory.store(fake_heap_address1, passwd1)<br><br>    simulation = project.factory.simgr(initial_state)<br>    <br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">is_successful</span>(<span class="hljs-params">state</span>):<br>        stdout_output = state.posix.dumps(<span class="hljs-number">1</span>)<br>        <span class="hljs-keyword">if</span> <span class="hljs-string">b&#x27;Good Job.\n&#x27;</span> <span class="hljs-keyword">in</span> stdout_output:<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span><br>        <span class="hljs-keyword">else</span>: <br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">should_abort</span>(<span class="hljs-params">state</span>):<br>        stdout_output = state.posix.dumps(<span class="hljs-number">1</span>)<br>        <span class="hljs-keyword">if</span> <span class="hljs-string">b&#x27;Try again.\n&#x27;</span> <span class="hljs-keyword">in</span>  stdout_output:<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span><br>        <span class="hljs-keyword">else</span>: <br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br><br>    simulation.explore(find=is_successful, avoid=should_abort)<br>  <br>    <span class="hljs-keyword">if</span> simulation.found:<br>        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> simulation.found:<br>            solution_state = i<br>            solution0 = solution_state.solver.<span class="hljs-built_in">eval</span>(passwd0, cast_to=<span class="hljs-built_in">bytes</span>)<br>            solution1 = solution_state.solver.<span class="hljs-built_in">eval</span>(passwd1, cast_to=<span class="hljs-built_in">bytes</span>)<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;[+] Success! Solution is: &#123;0&#125; &#123;1&#125;&quot;</span>.<span class="hljs-built_in">format</span>(solution0.decode(<span class="hljs-string">&#x27;utf-8&#x27;</span>), solution1.decode(<span class="hljs-string">&#x27;utf-8&#x27;</span>)))<br>            <span class="hljs-comment">#print(solution0, solution1)</span><br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-keyword">raise</span> Exception(<span class="hljs-string">&#x27;Could not find the solution&#x27;</span>)<br>    <br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&quot;__main__&quot;</span>:<br>    Go()<br></code></pre></td></tr></table></figure>

<h2 id="八-符号化文件内容"><a href="#八-符号化文件内容" class="headerlink" title="八.符号化文件内容"></a>八.符号化文件内容</h2><p>程序源码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> __cdecl __noreturn <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">const</span> <span class="hljs-type">char</span> **argv, <span class="hljs-type">const</span> <span class="hljs-type">char</span> **envp)</span><br>&#123;<br>  <span class="hljs-type">int</span> i; <span class="hljs-comment">// [esp+Ch] [ebp-Ch]</span><br><br>  <span class="hljs-built_in">memset</span>(buffer, <span class="hljs-number">0</span>, <span class="hljs-number">0x40</span>u);<br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Enter the password: &quot;</span>);<br>  __isoc99_scanf(<span class="hljs-string">&quot;%64s&quot;</span>, buffer);<br>  ignore_me((<span class="hljs-type">int</span>)buffer, <span class="hljs-number">0x40</span>u);<br>  <span class="hljs-built_in">memset</span>(buffer, <span class="hljs-number">0</span>, <span class="hljs-number">0x40</span>u);<br>  fp = fopen(<span class="hljs-string">&quot;OJKSQYDP.txt&quot;</span>, <span class="hljs-string">&quot;rb&quot;</span>);<br>  fread(buffer, <span class="hljs-number">1u</span>, <span class="hljs-number">0x40</span>u, fp);<br>  fclose(fp);<br>  unlink(<span class="hljs-string">&quot;OJKSQYDP.txt&quot;</span>);<br>  <span class="hljs-keyword">for</span> ( i = <span class="hljs-number">0</span>; i &lt;= <span class="hljs-number">7</span>; ++i )<br>    *(_BYTE *)(i + <span class="hljs-number">0x804A0A0</span>) = complex_function(*(<span class="hljs-type">char</span> *)(i + <span class="hljs-number">0x804A0A0</span>), i);<br>  <span class="hljs-keyword">if</span> ( <span class="hljs-built_in">strncmp</span>(buffer, <span class="hljs-string">&quot;AQWLCTXB&quot;</span>, <span class="hljs-number">9u</span>) )<br>  &#123;<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Try again.&quot;</span>);<br>    <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<br>  &#125;<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Good Job.&quot;</span>);<br>  <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);<br>&#125;<br><br><br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> __cdecl <span class="hljs-title function_">ignore_me</span><span class="hljs-params">(<span class="hljs-type">int</span> a1, <span class="hljs-type">size_t</span> n)</span><br>&#123;<br>  <span class="hljs-type">void</span> *v2; <span class="hljs-comment">// esp</span><br>  <span class="hljs-type">int</span> v4; <span class="hljs-comment">// [esp+0h] [ebp-28h]</span><br>  <span class="hljs-type">void</span> *ptr; <span class="hljs-comment">// [esp+Ch] [ebp-1Ch]</span><br>  <span class="hljs-type">size_t</span> v6; <span class="hljs-comment">// [esp+10h] [ebp-18h]</span><br>  <span class="hljs-type">void</span> *s; <span class="hljs-comment">// [esp+14h] [ebp-14h]</span><br>  FILE *stream; <span class="hljs-comment">// [esp+18h] [ebp-10h]</span><br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> v9; <span class="hljs-comment">// [esp+1Ch] [ebp-Ch]</span><br><br>  ptr = (<span class="hljs-type">void</span> *)a1;<br>  v9 = __readgsdword(<span class="hljs-number">0x14</span>u);<br>  v6 = n - <span class="hljs-number">1</span>;<br>  v2 = alloca(<span class="hljs-number">16</span> * ((n + <span class="hljs-number">15</span>) / <span class="hljs-number">0x10</span>));<br>  s = &amp;v4;<br>  <span class="hljs-built_in">memset</span>(&amp;v4, <span class="hljs-number">0</span>, n);<br>  unlink(<span class="hljs-string">&quot;OJKSQYDP.txt&quot;</span>);<br>  stream = fopen(<span class="hljs-string">&quot;OJKSQYDP.txt&quot;</span>, <span class="hljs-string">&quot;a+b&quot;</span>);<br>  fwrite(ptr, <span class="hljs-number">1u</span>, n, stream);<br>  fseek(stream, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);<br>  __isoc99_fscanf(stream, <span class="hljs-string">&quot;%64s&quot;</span>, s);<br>  fseek(stream, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);<br>  fwrite(s, <span class="hljs-number">1u</span>, n, stream);<br>  fclose(stream);<br>  <span class="hljs-keyword">return</span> __readgsdword(<span class="hljs-number">0x14</span>u) ^ v9;<br>&#125;<br></code></pre></td></tr></table></figure>

<div id="paginator"></div></div><div id="post-footer"><div id="pages"><div class="footer-link" style="width: 50%;text-align:right;border-right:1px #fe2 solid"><a href="/2022/04/07/%E9%80%86%E5%90%91%E6%A4%8D%E7%89%A9%E5%A4%A7%E6%88%98%E5%83%B5%E5%B0%B8/">← Next angr的使用</a></div><div class="footer-link" style="width: 50%;right:1px;border-left:1px #fe2 solid"><a href="/2022/03/27/nkctf/">nkctf  逆向wp Prev →</a></div></div></div><div id="Valine"></div></div><div id="bottom-btn"><a id="to-index" href="#toc-div" title="INDEX">≡</a><a id="to-top" onClick="scrolls.scrolltop();" title="to top" style="opacity: 0; display: none;">∧</a></div></article><aside><div id="aside-top"><div id="about"><a href="/" id="logo"><img src="https://raw.githubusercontent.com/shimmer123456/img/main/img/touxiang.png" alt="Logo"></a><h1 id="Dr"><a href="/">shimmer</a></h1><div id="description"><p>一</p><p>些</p><p>小</p><p>笔</p><p>记</p><p>或</p><p>是</p><p>小</p><p>感</p><p>悟</p></div></div><div id="aside-block"><div id="toc-div"><h1>INDEX</h1><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80-good%EF%BC%9A"><span class="toc-number">1.</span> <span class="toc-text">一.good：</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8C-good-avoid"><span class="toc-number">2.</span> <span class="toc-text">二.good_avoid</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%89-%E5%A4%9A%E4%B8%AAgood%E6%88%96avoid"><span class="toc-number">3.</span> <span class="toc-text">三.多个good或avoid</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9B%9B-%E7%AC%A6%E5%8F%B7%E5%8C%96%E5%AF%84%E5%AD%98%E5%99%A8"><span class="toc-number">4.</span> <span class="toc-text">四.符号化寄存器</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%94-%E7%AC%A6%E5%8F%B7%E5%8C%96%E6%A0%88"><span class="toc-number">5.</span> <span class="toc-text">五.符号化栈</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%AD-%E7%AC%A6%E5%8F%B7%E5%8C%96%E5%86%85%E5%AD%98"><span class="toc-number">6.</span> <span class="toc-text">六.符号化内存</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%83-%E7%AC%A6%E5%8F%B7%E5%8C%96%E5%8A%A8%E6%80%81%E5%86%85%E5%AD%98"><span class="toc-number">7.</span> <span class="toc-text">七.符号化动态内存</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%AB-%E7%AC%A6%E5%8F%B7%E5%8C%96%E6%96%87%E4%BB%B6%E5%86%85%E5%AE%B9"><span class="toc-number">8.</span> <span class="toc-text">八.符号化文件内容</span></a></li></ol></div></div></div><footer><nobr>published with <a target="_blank" rel="noopener" href="http://hexo.io">Hexo</a></nobr><wbr><nobr> Theme <a target="_blank" rel="noopener" href="https://github.com/Yue-plus/hexo-theme-arknights">Arknight</a></nobr><wbr><nobr>by <a target="_blank" rel="noopener" href="https://github.com/Yue-plus">Yue_plus</a></nobr></footer></aside></main><canvas id="canvas-dust"></canvas><script src="/js/search.js"></script><script class="pjax-js">reset=_=>{new Valine({
 el: '#Valine'
 , appId: 'fvW1eWgLvTdXfECCW1Bu9g6J-gzGzoHsz'
 , appKey: 'stD8FmxHNFFxhkzXholoBHdq' , placeholder: '此条评论委托企鹅物流发送'
});code.findCode();mermaid.init(undefined, ('.mermaid'));}</script><script src="/js/arknights.js"></script><script>window.addEventListener("load",()=>{reset()})</script></body></html>